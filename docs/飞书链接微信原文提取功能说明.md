# 飞书链接微信原文提取功能说明

## 功能概述

当处理以 `https://waytoagi.feishu.cn/` 开头的飞书链接时，系统会自动执行以下步骤：

1. **检测飞书链接**：自动识别飞书域名的链接
2. **提取原文链接**：在飞书页面的前10行中搜索微信公众号原文链接
3. **智能重定向**：如果找到原文链接，自动使用原文链接获取内容
4. **回退机制**：如果没有找到原文链接，则使用飞书页面内容

## 支持的原文链接格式

系统支持以下几种原文链接格式：

```
原文链接：https://mp.weixin.qq.com/s/abc123
原文链接:https://mp.weixin.qq.com/s/def456  
原文链接： https://mp.weixin.qq.com/s/ghi789
原文链接 : https://mp.weixin.qq.com/s/jkl012
原文链接：https://mp.weixin.qq.com/s?__biz=abc&mid=123&idx=1&sn=def
```

### 格式要求

- **前缀**：必须包含"原文链接"字样
- **分隔符**：支持中文冒号（：）和英文冒号（:）
- **空格**：支持冒号前后的空格
- **链接**：必须是完整的微信公众号文章链接（以 `https://mp.weixin.qq.com/` 开头）
- **位置**：原文链接必须出现在网页的前10行文本内容中

## 使用方法

### 方法1：使用 urls_to_siyuan.py（推荐）

1. 复制飞书链接到剪贴板
2. 运行脚本：
   ```bash
   python urls_to_siyuan.py
   ```
3. 系统会自动：
   - 检测飞书链接
   - 提取微信原文链接（如果存在）
   - 转换为Markdown文件
   - 导入到思源笔记
   - 移动文件到"已转思源"目录

### 方法2：使用 urls_to_markdown.py

1. 复制飞书链接到剪贴板
2. 运行脚本：
   ```bash
   python urls_to_markdown.py
   ```
3. 系统会生成Markdown文件到指定目录

## 工作流程示例

### 场景1：找到微信原文链接

```
输入：https://waytoagi.feishu.cn/wiki/example123
↓
检测到飞书链接，获取页面内容
↓
在前10行中找到：原文链接：https://mp.weixin.qq.com/s/abc123
↓
使用微信原文链接获取内容：https://mp.weixin.qq.com/s/abc123
↓
转换为Markdown并保存
```

### 场景2：未找到微信原文链接

```
输入：https://waytoagi.feishu.cn/docs/example456
↓
检测到飞书链接，获取页面内容
↓
前10行中未找到微信公众号原文链接
↓
直接使用飞书页面内容
↓
转换为Markdown并保存
```

## 日志输出示例

当处理飞书链接时，您会看到类似的日志输出：

```
INFO - 检测到飞书链接，尝试提取微信公众号原文链接: https://waytoagi.feishu.cn/wiki/example
INFO - 在飞书页面中找到微信公众号原文链接: https://mp.weixin.qq.com/s/abc123
INFO - 找到原文链接，将使用原文链接获取内容: https://mp.weixin.qq.com/s/abc123
```

或者：

```
INFO - 检测到飞书链接，尝试提取微信公众号原文链接: https://waytoagi.feishu.cn/docs/example
INFO - 未找到微信公众号原文链接，使用飞书页面内容
```

## 技术实现

### 核心文件修改

- **utilities/web_downloader.py**：添加了 `_extract_wechat_original_link()` 方法和飞书链接检测逻辑

### 关键方法

1. **`_extract_wechat_original_link(content)`**：
   - 从HTML内容中提取微信原文链接
   - 只检查前10行内容
   - 支持多种格式的原文链接

2. **`fetch_webpage(url)` 增强**：
   - 检测飞书链接
   - 自动提取和重定向到原文链接
   - 保持向后兼容性

## 测试验证

项目包含完整的测试套件：

- **test_feishu_wechat_extraction.py**：测试链接提取功能
- **test_feishu_integration.py**：测试完整集成功能

运行测试：
```bash
python test_feishu_wechat_extraction.py
python test_feishu_integration.py
```

## 注意事项

1. **网络连接**：需要能够访问飞书和微信公众号
2. **内容位置**：原文链接必须在页面前10行中
3. **链接格式**：必须是完整的微信公众号链接
4. **编码处理**：自动处理各种字符编码
5. **错误处理**：包含完整的异常处理机制

## 兼容性

- ✅ 完全向后兼容现有功能
- ✅ 不影响其他网站的处理
- ✅ 支持所有现有的转换器（markdownify、html2text、builtin）
- ✅ 支持批量处理和单个链接处理

## 更新历史

- **2025-08-17**：初始实现飞书链接微信原文提取功能
  - 添加自动检测和提取功能
  - 完整的测试套件
  - 详细的日志输出
  - 向后兼容保证
