# 思源笔记高级SQL查询系统 - 项目总结

## 🎯 项目概述

基于思源笔记数据库结构，我设计并实现了一套完整的笔记数据查询和统计系统，包含**22个实用的SQL查询场景**，涵盖了从基础统计到高级数据挖掘的各种需求。

## 📊 查询场景统计

### 查询分类分布
- **基础统计**: 4个查询 - 文档总体统计、块类型分布、笔记本排行、标题层级分布
- **内容分析**: 4个查询 - 字数统计、标签使用、引用关系、代码块分析  
- **时间维度**: 4个查询 - 创建时间分布、活跃文档、长期未更新、每日写作统计
- **高级查询**: 5个查询 - 孤立文档检测、高价值文档识别、标签共现、引用网络、内容相似度
- **特殊用途**: 5个查询 - 图片资源、数学公式、任务列表、表格使用、自定义属性

### 核心特性
✅ **中文字段别名** - 所有查询结果使用中文字段名，便于理解  
✅ **时间格式化** - 统一使用 `datetime(时间戳/1000, 'unixepoch', 'localtime')` 格式  
✅ **文档链接生成** - 自动生成 `siyuan://blocks/` 格式的内部链接  
✅ **合理限制** - 添加适当的 LIMIT 限制，避免查询结果过大  
✅ **参数化查询** - 提供3个参数化查询函数，支持动态条件  
✅ **完整文档** - 包含详细的使用指南和API文档

## 🗂️ 文件结构

```
├── utilities/
│   └── advanced_sql_queries.py     # 核心查询模块 (784行)
├── examples/
│   └── advanced_query_demo.py      # 演示脚本 (300行)
├── docs/
│   └── 思源笔记高级SQL查询使用指南.md  # 使用指南 (300行)
└── siyuan_advanced_queries.json    # 导出的查询数据 (296行)
```

## 🔍 查询场景详解

### 1. 基础统计查询
- **文档总体统计**: 统计文档总数、平均字数、笔记本数量等基础信息
- **块类型分布统计**: 分析段落、标题、列表等各种块类型的使用分布
- **笔记本统计排行**: 各笔记本的文档数量、字数统计，识别最活跃笔记本
- **标题层级分布**: 统计H1-H6各级标题使用情况，了解文档结构层次

### 2. 内容分析查询  
- **字数统计排行**: 按字数排序找出最长/最短文档，识别重要内容
- **标签使用统计**: 统计标签使用频率和文档覆盖率，优化标签体系
- **引用关系分析**: 分析文档间引用关系，找出知识网络中的核心文档
- **代码块统计分析**: 统计各编程语言代码块分布，了解技术栈使用

### 3. 时间维度查询
- **创建时间分布**: 按月份统计文档创建情况，分析写作活跃度变化
- **最近活跃文档**: 查找最近更新的文档，便于继续编辑工作
- **长期未更新文档**: 识别90天以上未更新的文档，便于内容维护
- **每日写作统计**: 最近30天的每日创建和更新统计，了解写作习惯

### 4. 高级查询
- **孤立文档检测**: 查找没有任何引用关系的文档，改善知识连接
- **高价值文档识别**: 综合字数、引用数、标签数等指标识别重要文档
- **标签共现分析**: 分析经常一起出现的标签组合，优化标签设计
- **引用网络深度分析**: 分析文档引用深度广度，识别核心枢纽、权威文档等
- **内容相似度分析**: 基于共同标签找出相似文档，便于内容整合

### 5. 特殊用途查询
- **图片资源统计**: 统计文档中图片使用情况，便于媒体资源管理
- **数学公式使用统计**: 统计数学公式块和行内公式，适用于学术文档
- **任务列表统计**: 统计任务列表完成情况，跟踪待办事项进度
- **表格使用统计**: 统计文档中表格使用情况，便于结构化数据管理
- **自定义属性分布**: 统计各种自定义属性使用情况，优化属性体系

## 🛠️ 参数化查询功能

提供3个灵活的参数化查询函数：

1. **`get_documents_by_tag(tag_name, limit)`** - 根据标签查询文档
2. **`get_documents_by_custom_attribute(attribute_name, attribute_value, limit)`** - 根据自定义属性查询
3. **`get_documents_by_date_range(start_date, end_date, date_type, limit)`** - 根据日期范围查询

## 📋 使用示例

### 基本使用
```python
from utilities.advanced_sql_queries import get_query_sql, get_all_query_names

# 获取所有查询名称
queries = get_all_query_names()  # 返回22个查询名称

# 获取特定查询的SQL
sql = get_query_sql("高价值文档识别")

# 执行查询
from utilities.api_client import SiyuanAPI
api = SiyuanAPI()
result = api.call_api('/api/query/sql', {'stmt': sql})
```

### 参数化查询
```python
# 查询包含"Python"标签的文档
sql = get_documents_by_tag("Python", 50)

# 查询分类为"技术"的文档  
sql = get_documents_by_custom_attribute("classify", "技术", 100)

# 查询最近7天更新的文档
sql = get_documents_by_date_range("2024-07-20", "2024-07-27", "updated", 50)
```

## 🎮 演示功能

运行演示脚本体验完整功能：
```bash
python examples/advanced_query_demo.py
```

演示包含：
- 📁 查询分类浏览 - 按分类展示所有查询
- 🔍 关键词搜索 - 根据关键词快速找到相关查询  
- 📋 查询详情展示 - 显示查询的描述、应用场景、SQL语句
- 🛠️ 参数化查询示例 - 演示动态查询生成
- 📊 实际执行示例 - 连接思源笔记执行查询
- 💾 数据导出功能 - 导出为JSON格式
- 🎯 交互式浏览器 - 支持实时搜索和查看

## 📈 实际测试结果

在包含10,061个文档的思源笔记数据库中测试：
- ✅ 所有查询执行成功
- ✅ 查询性能良好（毫秒级响应）
- ✅ 结果格式正确（中文字段名、时间格式化）
- ✅ 文档链接生成正确
- ✅ 统计数据准确（文档总数、块类型分布等）

## 🎯 应用价值

### 1. 数据洞察
- 了解笔记库整体规模和结构特点
- 识别写作习惯和活跃度变化
- 发现知识网络中的关键节点

### 2. 内容管理
- 快速定位高价值和重要文档
- 识别需要维护的长期未更新内容
- 发现孤立文档改善知识连接

### 3. 标签优化
- 分析标签使用频率和覆盖率
- 发现标签共现模式优化分类体系
- 统计自定义属性使用情况

### 4. 写作分析
- 按时间维度分析创建和更新模式
- 统计字数分布识别内容特点
- 跟踪任务列表完成进度

## 🔧 技术特点

### 1. 模块化设计
- 查询按功能分类组织，便于维护和扩展
- 提供完整的工具函数支持查询管理
- 支持关键词搜索和分类浏览

### 2. 用户友好
- 中文字段别名提高可读性
- 自动生成文档链接便于快速访问
- 详细的查询描述和应用场景说明

### 3. 灵活扩展
- 参数化查询支持动态条件
- 标准化的查询结构便于添加新查询
- 完整的导出功能支持数据交换

### 4. 实用性强
- 基于真实使用场景设计
- 涵盖从基础统计到高级分析的各种需求
- 提供完整的演示和文档支持

## 🚀 后续扩展建议

1. **可视化支持** - 集成图表库生成统计图表
2. **定时报告** - 支持定期生成数据分析报告
3. **更多维度** - 添加更多分析维度如情感分析、关键词提取等
4. **性能优化** - 针对大型数据库优化查询性能
5. **Web界面** - 开发Web界面支持在线查询和可视化

---

**总结**: 这套SQL查询系统为思源笔记用户提供了强大的数据分析能力，通过22个精心设计的查询场景，用户可以深入了解自己的笔记使用习惯，优化知识管理策略，提高写作和学习效率。系统设计注重实用性和易用性，为思源笔记的数据挖掘和分析提供了完整的解决方案。
