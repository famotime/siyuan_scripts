# 思源笔记Markdown文件导入工具使用说明

## 功能说明

`create_notes_from_md.py` 脚本用于将本地Markdown文件批量导入到思源笔记中。该脚本基于 `functions.py` 通用函数库构建，提供了可靠的API操作和错误处理。

## 主要功能

- 🔍 自动查找或创建指定的笔记本
- 📁 自动创建父文件夹用于组织导入的文档
- 📝 批量导入MD文件到思源笔记
- 📊 提供详细的导入日志和结果统计
- ⚡ 基于通用函数库，可靠性更高
- 🔧 支持环境变量配置，使用更灵活
- 📎 **智能媒体文件上传**：自动检测并上传MD文件中的图片、音频、视频文件
- 🔄 **软回车转换**：自动将软回车转换为硬回车，确保正确的换行显示

## 默认设置

- **MD文件源目录**: `export_wiznotes/output/`
- **目标笔记本**: "剪藏笔记本"
- **父文件夹**: "来自为知笔记"
- **API地址**: `http://127.0.0.1:6806`

## 使用步骤

### 1. 确保思源笔记正在运行
启动思源笔记应用程序。

### 2. 检查API设置（可选）
如果思源笔记开启了API认证：
- 打开思源笔记
- 进入 `设置` > `关于`
- 查看并复制 API Token

### 3. 设置认证（如需要）
有两种方式设置API Token：

**方式一：环境变量**
```bash
export SIYUAN_TOKEN="your_token_here"
```

**方式二：直接修改代码**
在 `main()` 函数中修改：
```python
api = SiYuanAPI(token="your_token_here")
```

### 4. 准备MD文件
将要导入的Markdown文件放入 `export_wiznotes/output/` 目录。

**媒体文件支持**：
- 📸 **图片文件**：png, jpg, jpeg, gif, svg, webp, bmp, ico
- 🎵 **音频文件**：mp3, wav, m4a, aac, ogg, flac
- 🎬 **视频文件**：mp4, mov, avi, mkv, webm, wmv, flv

脚本会自动检测MD文件中的媒体文件引用，将文件上传到思源笔记并更新链接。

### 5. 运行脚本
```bash
python create_notes_from_md.py
```

## 自定义配置

### 环境变量配置
创建 `.env` 文件或设置环境变量：
```bash
# 思源笔记API配置
SIYUAN_API_TOKEN=your_token_here
SIYUAN_API_URL=http://127.0.0.1:6806

# 导入配置
MD_FOLDER=your/custom/md/folder
NOTEBOOK_NAME=你的笔记本名称
PARENT_FOLDER=/Web收集箱/你的文件夹名称

# 媒体文件配置
UPLOAD_MEDIA=true  # 是否上传媒体文件（true/false）

# 文档格式配置
CONVERT_SOFT_BREAKS=true  # 是否转换软回车为硬回车（true/false）
```

### 直接在代码中修改
在 `main()` 函数中的默认值：
```python
DEFAULT_MD_FOLDER = "your/custom/path"
DEFAULT_NOTEBOOK_NAME = "你的笔记本名称"
DEFAULT_PARENT_FOLDER = "/Web收集箱/你的文件夹名称"
```

## 输出日志

脚本会显示详细的执行日志：
- 连接状态
- 笔记本创建/查找结果
- 每个文件的导入状态
- 最终导入统计

## 注意事项

1. 确保思源笔记正在运行且可以通过 `http://127.0.0.1:6806` 访问
2. 如果使用相同的路径重复导入，不会覆盖已有文档
3. 文件名会作为文档标题（去掉.md扩展名）
4. 脚本会自动处理UTF-8编码的Markdown文件
5. **媒体文件处理**：脚本会自动检测MD文件中的媒体文件引用并上传

## 媒体文件处理机制

### 🔍 **自动检测**
脚本会扫描MD文件中的以下格式：
- 图片：`![alt text](path/to/image.png)`
- 音视频：`[描述](path/to/media.mp3)`

### 📁 **路径解析**
- ✅ **相对路径**：`./images/photo.jpg` 相对于MD文件位置
- ✅ **绝对路径**：`/home/user/media/video.mp4`
- ❌ **网络链接**：`https://example.com/image.png` 会跳过

### 📤 **上传流程**
1. 检测到媒体文件引用
2. 验证文件是否存在且为支持格式
3. 上传到思源笔记资源目录
4. 自动更新MD文件中的链接为思源格式

### 📝 **链接更新示例**
```markdown
# 原始链接
![我的图片](./images/photo.jpg)
[背景音乐](../audio/music.mp3)

# 上传后自动更新为
![我的图片](assets/photo-20231201123456-abc.jpg)
[背景音乐](assets/music-20231201123457-def.mp3)
```

## 软回车转换功能

### 🔄 **什么是软回车和硬回车？**

- **软回车**：单个换行符（`\n`），在Markdown中通常不产生可见的换行效果
- **硬回车**：两个换行符（`\n\n`）或行末加两个空格+换行符，在Markdown中产生真正的换行

### 📝 **转换示例**

**原始文档（软回车）**：
```markdown
这是第一行文本
这是第二行文本
这是第三行文本
```

**转换后（硬回车）**：
```markdown
这是第一行文本

这是第二行文本

这是第三行文本
```

### ⚙️ **智能转换规则**

脚本会智能识别不同类型的内容，只对普通文本行进行转换：

- ✅ **转换**：普通文本段落之间
- ❌ **不转换**：标题行（`# ## ###`）
- ❌ **不转换**：列表项（`- * +` 或数字列表）
- ❌ **不转换**：代码块（`` ``` ``）
- ❌ **不转换**：引用行（`>`）
- ❌ **不转换**：表格行（包含 `|`）
- ❌ **不转换**：分割线（`---` `***`）

### 🎯 **使用场景**

这个功能特别适用于：
- 从其他笔记软件导出的Markdown文件
- 需要确保在思源笔记中正确显示换行的文档
- 提高文档在思源笔记中的可读性

## 测试和调试

### 🧪 测试媒体文件上传

如果遇到媒体文件无法正确上传或显示的问题，可以使用专门的测试脚本：

```bash
python test_media_upload.py
```

测试脚本提供三种模式：
1. **测试媒体文件上传** - 直接测试文件上传API
2. **测试Markdown媒体处理** - 测试MD文件中媒体链接的处理
3. **综合测试** - 同时测试上述两个功能

### 🔍 调试步骤

1. **检查文件路径**
   - 确保媒体文件与MD文件的相对路径正确
   - 检查文件是否存在且可读

2. **查看详细日志**
   - 脚本会输出详细的调试信息
   - 注意上传API的返回结果和错误信息

3. **验证思源笔记资源**
   - 在思源笔记中打开 `工作空间/data/assets/` 目录
   - 确认文件是否成功上传

## 错误处理

### 常见问题与解决方案

1. **🔌 连接失败**
   - 确保思源笔记正在运行
   - 检查API地址是否正确（默认：http://127.0.0.1:6806）
   - 如果需要，检查API Token是否正确

2. **📚 找不到笔记本**
   - 确保目标笔记本已存在
   - 检查笔记本名称是否正确（区分大小写）

3. **📝 文件导入失败**
   - 检查MD文件是否存在且可读
   - 确保MD文件编码为UTF-8

4. **📎 媒体文件上传失败**
   - 使用 `python test_media_upload.py` 进行专项测试
   - 检查媒体文件路径是否正确（相对于MD文件）
   - 确保媒体文件格式受支持
   - 检查思源笔记磁盘空间是否充足
   - 验证API Token权限（如果需要认证）

5. **🖼️ 媒体文件无法显示**
   - 检查上传后的资源路径格式是否正确
   - 确认资源文件确实上传到了 `assets/` 目录
   - 查看思源笔记控制台是否有错误信息
   - 尝试在思源笔记中手动引用资源文件测试

### 📋 调试清单

- [ ] 思源笔记是否正在运行？
- [ ] API地址是否可访问？
- [ ] 如果启用认证，Token是否正确？
- [ ] MD文件路径是否正确？
- [ ] 媒体文件是否存在且格式支持？
- [ ] 媒体文件与MD文件的相对路径是否正确？
- [ ] 思源笔记是否有足够的存储空间？

## 依赖包

脚本依赖以下包（已包含在requirements.txt中）：
- requests
- pathlib（Python标准库）
- logging（Python标准库）